<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Virtual - RS Sehat Selalu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body { 
            background: #f8f9fa;
        }
        
        #chat-window::-webkit-scrollbar { 
            width: 6px; 
        }
        #chat-window::-webkit-scrollbar-thumb { 
            background: #94a3b8;
            border-radius: 3px; 
        }
        #chat-window::-webkit-scrollbar-track { 
            background: #f1f5f9; 
        }
        #chat-window { 
            scroll-behavior: smooth; 
        }
        
        .chat-container {
            max-width: 900px;
            height: 95vh;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .message-enter {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #64748b;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        @media (max-width: 640px) {
            .chat-container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 sm:p-4">
    
    <div class="chat-container bg-white rounded-none sm:rounded-lg overflow-hidden flex flex-col">
        
        <header class="bg-white border-b-2 border-blue-600 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img 
                        src="/static/logo.jpg" 
                        alt="RS Sehat Selalu" 
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        class="h-12 w-12 object-contain rounded"
                    >
                    <div class="h-12 w-12 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-lg" style="display:none;">
                        RS
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <img 
                            src="static/avatar.jpeg"
                            alt="Kiko" 
                            onerror="this.style.display='none';" 
                            class="h-10 w-10 rounded-full border-2 border-blue-100"
                        >
                        <div>
                            <h1 class="text-lg font-semibold text-gray-900">Asisten Virtual KIKO (Knowledge & Information Kiosk Operator)</h1>
                            <p class="text-sm text-gray-600">Layanan Informasi 24 Jam</p>
                        </div>
                    </div>
                </div>
                
                <div id="health-status" class="flex items-center gap-2 px-3 py-1.5 bg-green-50 border border-green-200 rounded-md">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span class="text-xs font-medium text-green-700">Tersedia</span>
                </div>
            </div>
        </header>

        <div id="chat-window" class="flex-grow p-6 space-y-4 overflow-y-auto bg-gray-50">
            <div class="flex justify-start message-enter">
                <div class="flex gap-3 max-w-[85%]">
                    <img 
                        src="static/avatar.jpeg"
                        alt="Kiko" 
                        onerror="this.style.display='none';" 
                        class="w-10 h-10 rounded-full flex-shrink-0 border border-gray-200"
                    >
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                        <p class="text-sm text-gray-800 leading-relaxed mb-3">
                            Selamat datang di layanan Asisten Virtual RS Sehat Selalu.
                        </p>
                        <p class="text-sm text-gray-700 leading-relaxed mb-3">
                            Saya dapat membantu Anda untuk:
                        </p>
                        <ul class="text-sm text-gray-700 space-y-1.5 ml-1">
                            <li class="flex items-start gap-2">
                                <span class="text-blue-600 mt-0.5">•</span>
                                <span>Informasi jadwal praktik dokter</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-blue-600 mt-0.5">•</span>
                                <span>Pembuatan janji temu konsultasi</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-blue-600 mt-0.5">•</span>
                                <span>Informasi layanan dan fasilitas rumah sakit</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-blue-600 mt-0.5">•</span>
                                <span>Pertanyaan umum seputar kesehatan</span>
                            </li>
                        </ul>
                        <p class="text-sm text-gray-600 mt-3">
                            Silakan sampaikan kebutuhan Anda.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="border-t border-gray-200 bg-white p-4">
            <div class="flex gap-2 mb-3 overflow-x-auto pb-2">
                <button class="quick-btn px-4 py-2 text-xs font-medium bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-md border border-blue-200 whitespace-nowrap transition-colors" data-msg="Jadwal dokter spesialis jantung">
                    Jadwal Dokter
                </button>
                <button class="quick-btn px-4 py-2 text-xs font-medium bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-md border border-blue-200 whitespace-nowrap transition-colors" data-msg="Cara buat janji temu">
                    Buat Janji Temu
                </button>
                <button class="quick-btn px-4 py-2 text-xs font-medium bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-md border border-blue-200 whitespace-nowrap transition-colors" data-msg="Jam besuk pasien">
                    Jam Besuk
                </button>
                <button class="quick-btn px-4 py-2 text-xs font-medium bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-md border border-blue-200 whitespace-nowrap transition-colors" data-msg="Informasi IGD">
                    IGD 24 Jam
                </button>
            </div>

            <div class="flex gap-3">
                <input 
                    id="user-input" 
                    type="text" 
                    placeholder="Ketik pertanyaan atau kebutuhan Anda..." 
                    class="flex-1 px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 bg-white"
                />
                <button 
                    id="send-button" 
                    class="px-5 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center"
                >
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="mt-3 flex items-start gap-2 text-xs text-gray-500">
                <i data-lucide="info" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                <p class="leading-relaxed">
                    <strong>Disclaimer:</strong> Informasi yang diberikan bersifat umum dan tidak menggantikan konsultasi medis langsung dengan dokter. Untuk keluhan atau kondisi medis yang serius, segera kunjungi IGD atau hubungi dokter yang tersedia.
                </p>
            </div>
        </div>

    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const input = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const healthStatus = document.getElementById('health-status');
        
        const KIKO_AVATAR = 'static/avatar.jpeg';

        function appendMessage(text, isUser) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'flex message-enter ' + (isUser ? 'justify-end' : 'justify-start');

            if (isUser) {
                messageContainer.innerHTML = `
                    <div class="flex gap-3 max-w-[85%] flex-row-reverse">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-600 text-white flex-shrink-0 text-sm font-medium border border-gray-500">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                        <div class="bg-blue-600 text-white rounded-lg p-4 shadow-sm">
                            <p class="text-sm leading-relaxed">${escapeHtml(text)}</p>
                        </div>
                    </div>
                `;
            } else {
                messageContainer.innerHTML = `
                    <div class="flex gap-3 max-w-[85%]">
                        <img 
                            src="${KIKO_AVATAR}" 
                            onerror="this.style.display='none';" 
                            class="w-10 h-10 rounded-full flex-shrink-0 border border-gray-200"
                            alt="Kiko"
                        >
                        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                            <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">${text}</p>
                        </div>
                    </div>
                `;
            }

            chatWindow.appendChild(messageContainer);
            lucide.createIcons();
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex justify-start message-enter';
            typingDiv.innerHTML = `
                <div class="flex gap-3 max-w-[85%]">
                    <img 
                        src="${KIKO_AVATAR}" 
                        class="w-10 h-10 rounded-full flex-shrink-0 border border-gray-200"
                    >
                    <div class="bg-white border border-gray-200 rounded-lg px-5 py-4 shadow-sm">
                        <div class="flex gap-1">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                </div>
            `;
            chatWindow.appendChild(typingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkHealth() {
            try {
                const res = await fetch('/api/health');
                if (res.ok) {
                    healthStatus.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full"></span><span class="text-xs font-medium text-green-700">Tersedia</span>';
                    healthStatus.className = 'flex items-center gap-2 px-3 py-1.5 bg-green-50 border border-green-200 rounded-md';
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                healthStatus.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full"></span><span class="text-xs font-medium text-red-700">Offline</span>';
                healthStatus.className = 'flex items-center gap-2 px-3 py-1.5 bg-red-50 border border-red-200 rounded-md';
            }
        }

        async function sendMessage(messageText = null) {
            const txt = messageText || input.value.trim();
            if (!txt) return;

            appendMessage(txt, true);
            if (!messageText) input.value = '';

            showTypingIndicator();

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ message: txt, user_id: 'guest' })
                });
                
                removeTypingIndicator();
                
                if (!res.ok) throw new Error('Server error: ' + res.status);
                
                const data = await res.json();
                let replyText = '';
                
                if (data.reply) {
                    if (typeof data.reply === 'object' && data.reply.reply) {
                        replyText = data.reply.reply;
                    } else if (typeof data.reply === 'string') {
                        replyText = data.reply;
                    } else {
                        replyText = JSON.stringify(data.reply);
                    }
                    appendMessage(replyText, false);
                } else {
                    appendMessage('Maaf, tidak dapat memproses permintaan Anda. Silakan coba lagi.', false);
                }

            } catch (error) {
                removeTypingIndicator();
                appendMessage('Terjadi gangguan koneksi. Silakan coba beberapa saat lagi atau hubungi resepsionis kami.', false);
                checkHealth();
            }
        }

        sendButton.addEventListener('click', () => sendMessage());
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        document.querySelectorAll('.quick-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                sendMessage(btn.getAttribute('data-msg'));
            });
        });

        window.onload = () => {
            checkHealth();
            lucide.createIcons();
            input.focus();
        };
    </script>
</body>
</html>